#!/bin/bash
#
# tmux-manager - Interactive tmux session manager
# Arrow keys to navigate, Enter to select
#

set -e

# Colors
BLACK='\033[0;30m'
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# Background colors
BG_BLUE='\033[44m'
BG_CYAN='\033[46m'
BG_WHITE='\033[47m'

hide_cursor() { printf '\033[?25l'; }
show_cursor() { printf '\033[?25h'; }
move_cursor() { printf '\033[%d;%dH' "$1" "$2"; }
clear_screen() { printf '\033[2J\033[H'; }

cleanup() {
    show_cursor
    tput cnorm 2>/dev/null || true
    clear_screen
}
trap cleanup EXIT

read_key() {
    local key
    IFS= read -rsn1 key 2>/dev/null

    if [[ $key == $'\x1b' ]]; then
        read -rsn2 -t 0.1 key 2>/dev/null
        case "$key" in
            '[A') echo "up" ;;
            '[B') echo "down" ;;
            *) echo "escape" ;;
        esac
    elif [[ $key == "" ]]; then
        echo "enter"
    elif [[ $key == "q" || $key == "Q" ]]; then
        echo "quit"
    elif [[ $key == "j" ]]; then
        echo "down"
    elif [[ $key == "k" ]]; then
        echo "up"
    else
        echo "other"
    fi
}

get_sessions() {
    tmux list-sessions -F "#{session_name}|#{session_windows}|#{?session_attached,attached,}" 2>/dev/null || echo ""
}

create_session() {
    local name="$1"
    [[ -z "$name" ]] && name="session-$(date +%H%M%S)"
    name=$(echo "$name" | tr ' ' '-' | tr -cd '[:alnum:]-_')

    if tmux has-session -t "$name" 2>/dev/null; then
        tmux attach-session -t "$name"
    else
        tmux new-session -s "$name"
    fi
}

get_terminal_size() {
    TERM_LINES=$(tput lines)
    TERM_COLS=$(tput cols)
}

draw_box() {
    local y=$1 x=$2 h=$3 w=$4 title="$5"

    # Top border
    move_cursor $y $x
    printf "${CYAN}╭"
    printf '─%.0s' $(seq 1 $((w-2)))
    printf "╮${NC}"

    # Title
    if [[ -n "$title" ]]; then
        move_cursor $y $((x + 2))
        printf "${CYAN}┤${BOLD}${WHITE} %s ${NC}${CYAN}├${NC}" "$title"
    fi

    # Sides
    for ((i=1; i<h-1; i++)); do
        move_cursor $((y+i)) $x
        printf "${CYAN}│${NC}"
        move_cursor $((y+i)) $((x+w-1))
        printf "${CYAN}│${NC}"
    done

    # Bottom border
    move_cursor $((y+h-1)) $x
    printf "${CYAN}╰"
    printf '─%.0s' $(seq 1 $((w-2)))
    printf "╯${NC}"
}

draw_menu() {
    local -n items=$1
    local -n info=$2
    local selected=$3

    get_terminal_size

    local box_width=50
    local box_height=$((${#items[@]} + 6))
    local start_y=$(( (TERM_LINES - box_height) / 2 ))
    local start_x=$(( (TERM_COLS - box_width) / 2 ))

    [[ $start_y -lt 1 ]] && start_y=1
    [[ $start_x -lt 1 ]] && start_x=1

    clear_screen

    # Draw box
    draw_box $start_y $start_x $box_height $box_width "tmux sessions"

    # Draw items
    local i=0
    local content_y=$((start_y + 2))
    local content_x=$((start_x + 2))

    for item in "${items[@]}"; do
        move_cursor $((content_y + i)) $content_x

        if [[ $i -eq $selected ]]; then
            printf "${BG_CYAN}${BLACK}${BOLD}"
        fi

        if [[ "$item" == "__NEW__" ]]; then
            if [[ $i -eq $selected ]]; then
                printf "  ➤ + New session                            ${NC}"
            else
                printf "  ${GREEN}+ New session${NC}"
            fi
        elif [[ "$item" == "__SKIP__" ]]; then
            if [[ $i -eq $selected ]]; then
                printf "  ➤ Skip (no tmux)                           ${NC}"
            else
                printf "  ${DIM}Skip (no tmux)${NC}"
            fi
        else
            local session_info="${info[$i]}"
            local windows=$(echo "$session_info" | cut -d'|' -f2)
            local attached=$(echo "$session_info" | cut -d'|' -f3)
            local suffix=""
            [[ -n "$attached" ]] && suffix=" ${GREEN}●${NC}"

            if [[ $i -eq $selected ]]; then
                printf "  ➤ %-30s %2sw${NC}" "$item" "$windows"
            else
                printf "    %-30s ${DIM}%sw${NC}%b" "$item" "$windows" "$suffix"
            fi
        fi

        [[ $i -eq $selected ]] && printf "${NC}"
        ((i++))
    done

    # Footer
    move_cursor $((start_y + box_height - 2)) $((start_x + 2))
    printf "${DIM}↑↓/jk${NC} navigate  ${DIM}Enter${NC} select  ${DIM}q${NC} quit"
}

prompt_session_name() {
    get_terminal_size

    local box_width=50
    local box_height=7
    local start_y=$(( (TERM_LINES - box_height) / 2 ))
    local start_x=$(( (TERM_COLS - box_width) / 2 ))

    clear_screen
    draw_box $start_y $start_x $box_height $box_width "New Session"

    move_cursor $((start_y + 2)) $((start_x + 3))
    printf "Enter session name:"

    move_cursor $((start_y + 4)) $((start_x + 3))
    printf "${DIM}(empty for auto-generated name)${NC}"

    move_cursor $((start_y + 3)) $((start_x + 3))
    printf "${CYAN}› ${NC}"

    show_cursor
    read -r session_name
    hide_cursor

    echo "$session_name"
}

main() {
    if ! command -v tmux &> /dev/null; then
        echo "Error: tmux is not installed."
        exit 1
    fi

    if [[ -n "$TMUX" ]]; then
        echo "Already inside tmux. Use Ctrl+b s to switch."
        exit 0
    fi

    # Build menu
    local menu_items=()
    local menu_info=()
    local sessions=$(get_sessions)

    if [[ -n "$sessions" ]]; then
        while IFS= read -r line; do
            local name=$(echo "$line" | cut -d'|' -f1)
            menu_items+=("$name")
            menu_info+=("$line")
        done <<< "$sessions"
    fi

    menu_items+=("__NEW__")
    menu_info+=("")
    menu_items+=("__SKIP__")
    menu_info+=("")

    local selected=0
    local total=${#menu_items[@]}

    hide_cursor
    draw_menu menu_items menu_info $selected

    while true; do
        local key=$(read_key)

        case "$key" in
            "up")
                ((selected--))
                [[ $selected -lt 0 ]] && selected=$((total - 1))
                ;;
            "down")
                ((selected++))
                [[ $selected -ge $total ]] && selected=0
                ;;
            "enter")
                local item="${menu_items[$selected]}"
                if [[ "$item" == "__NEW__" ]]; then
                    local name=$(prompt_session_name)
                    show_cursor
                    cleanup
                    create_session "$name"
                    exit 0
                elif [[ "$item" == "__SKIP__" ]]; then
                    exit 0
                else
                    show_cursor
                    cleanup
                    tmux attach-session -t "$item"
                    exit 0
                fi
                ;;
            "quit"|"escape")
                exit 0
                ;;
        esac

        draw_menu menu_items menu_info $selected
    done
}

main "$@"
