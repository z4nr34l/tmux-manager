#!/bin/bash
#
# tmux-manager - Interactive tmux session manager
# Allows selecting existing sessions or creating new ones
#

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Print colored output
print_header() {
    echo -e "${BOLD}${CYAN}╔════════════════════════════════════╗${NC}"
    echo -e "${BOLD}${CYAN}║      tmux session manager          ║${NC}"
    echo -e "${BOLD}${CYAN}╚════════════════════════════════════╝${NC}"
    echo
}

print_sessions() {
    local sessions="$1"
    local i=1

    if [[ -n "$sessions" ]]; then
        echo -e "${GREEN}Existing sessions:${NC}"
        echo -e "${YELLOW}─────────────────────────────────────${NC}"
        while IFS= read -r session; do
            local name=$(echo "$session" | cut -d: -f1)
            local windows=$(echo "$session" | cut -d: -f2 | xargs)
            local attached=$(echo "$session" | grep -q "attached" && echo " ${GREEN}(attached)${NC}" || echo "")
            echo -e "  ${BOLD}$i)${NC} ${BLUE}$name${NC} - $windows$attached"
            ((i++))
        done <<< "$sessions"
        echo -e "${YELLOW}─────────────────────────────────────${NC}"
    else
        echo -e "${YELLOW}No existing tmux sessions found.${NC}"
    fi
    echo
}

get_sessions() {
    tmux list-sessions 2>/dev/null || echo ""
}

create_session() {
    local name="$1"
    if [[ -z "$name" ]]; then
        # Generate default name
        name="session-$(date +%H%M%S)"
    fi

    # Sanitize name (replace spaces with dashes, remove special chars)
    name=$(echo "$name" | tr ' ' '-' | tr -cd '[:alnum:]-_')

    if tmux has-session -t "$name" 2>/dev/null; then
        echo -e "${RED}Session '$name' already exists. Attaching...${NC}"
        sleep 1
        tmux attach-session -t "$name"
    else
        echo -e "${GREEN}Creating new session: $name${NC}"
        sleep 0.5
        tmux new-session -s "$name"
    fi
}

attach_session() {
    local name="$1"
    if tmux has-session -t "$name" 2>/dev/null; then
        tmux attach-session -t "$name"
    else
        echo -e "${RED}Session '$name' not found.${NC}"
        return 1
    fi
}

main() {
    # Check if tmux is installed
    if ! command -v tmux &> /dev/null; then
        echo -e "${RED}Error: tmux is not installed.${NC}"
        exit 1
    fi

    # Already inside tmux?
    if [[ -n "$TMUX" ]]; then
        echo -e "${YELLOW}Already inside a tmux session.${NC}"
        echo -e "Use ${BOLD}tmux switch-client${NC} or ${BOLD}Ctrl+b s${NC} to switch sessions."
        exit 0
    fi

    clear
    print_header

    local sessions=$(get_sessions)
    local session_count=0
    local session_names=()

    if [[ -n "$sessions" ]]; then
        session_count=$(echo "$sessions" | wc -l)
        while IFS= read -r session; do
            session_names+=("$(echo "$session" | cut -d: -f1)")
        done <<< "$sessions"
    fi

    print_sessions "$sessions"

    # Show options
    echo -e "${GREEN}Options:${NC}"
    if [[ $session_count -gt 0 ]]; then
        echo -e "  ${BOLD}1-$session_count)${NC} Attach to existing session"
    fi
    echo -e "  ${BOLD}n)${NC} Create ${BOLD}n${NC}ew session with custom name"
    echo -e "  ${BOLD}q)${NC} ${BOLD}Q${NC}uit (no tmux)"
    echo

    # Read choice
    echo -ne "${CYAN}Select option: ${NC}"
    read -r choice

    case "$choice" in
        [qQ])
            echo -e "${YELLOW}Exiting without tmux session.${NC}"
            exit 0
            ;;
        [nN])
            echo -ne "${CYAN}Enter session name ${YELLOW}(Enter = session-HHMMSS)${NC}: "
            read -r session_name
            create_session "$session_name"
            ;;
        *)
            # Check if it's a number within range
            if [[ "$choice" =~ ^[0-9]+$ ]] && [[ $choice -ge 1 ]] && [[ $choice -le $session_count ]]; then
                local selected_session="${session_names[$((choice-1))]}"
                echo -e "${GREEN}Attaching to: $selected_session${NC}"
                sleep 0.5
                attach_session "$selected_session"
            else
                echo -e "${RED}Invalid option. Creating default session...${NC}"
                sleep 1
                create_session ""
            fi
            ;;
    esac
}

main "$@"
